<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
<head>
  <title>Invariants hidden in callbacks</title>
  <link rel="alternate" hreflang="en" href="invariants-in-callbacks.html" />
  <link rel="alternate" hreflang="sv" href="../../artiklar/index.html" />
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="&lt;p&gt;Callbacks might look simple and innocent, but they can be dangerous!&lt;/p&gt;">

  <link rel="stylesheet" href="../../styles/styles.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300|Lora">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.1/jquery.validate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <script>
      window.cookieconsent_options = {
          link: '/en/privacy',
          theme: 'dark-bottom',
          learnMore: 'More info',
          dismiss: 'Got it!',
          message: 'This website uses cookies to ensure you get the best experience.'
      };
  </script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111891505-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-111891505-1');
  </script>

      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:site" content="@edument">
      <meta name="twitter:title" content="Invariants hidden in callbacks">
      <meta name="twitter:description" content="&lt;p&gt;Callbacks might look simple and innocent, but they can be dangerous!&lt;/p&gt;">
      <meta name="twitter:image" content="/images/Edument_logo-share.jpg">
  <meta property="og:title" content="Invariants hidden in callbacks" />
  <meta property="og:description" content="&lt;p&gt;Callbacks might look simple and innocent, but they can be dangerous!&lt;/p&gt;" />
    <meta property="og:url" content="http://localhost:8080/en/articles/invariants-in-callbacks" />
      <meta property="og:image" content="http://localhost:8080/images/Edument_logo-share.jpg" />
  <meta property="og:type" content="website" />
</head>

<body class="section-start page_news_details">

<!-- Modal background cover -->
<div id="modal-collapse" class="modal-background"></div>

  <header>
    <nav class="navbar navbar-edument-top">
      <div class="navbar-inner">
        <div class="container">

        <div class="side-menu-wrapper">

          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <a class="navbar-brand" href="../../en.1.html"></a>
          </div>
        </div>
          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="navbar-collapse-top">
            <ul class="nav navbar-nav pull-right">
                    <li><a href="../education.html">Education</a></li>
                    <li><a href="../codebuddy.html">CodeBuddy</a></li>
                    <li><a href="../concept-and-product-development.html">Concept &amp; Product Development</a></li>
                    <li class="active"><a href="../about.html">About us <span class="sr-only">(current)</span></a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container -->
      </div><!-- /.navbar-inner -->
      <a class="langlink hidden-xs" href="../../artiklar/index.html">
          <img src="https://media.graphcms.com/4FSF3OtzRk2bJv1kFkiD"/>
      </a>
      <div class="mobilehamburger visible-xs"></div>
    </nav>

    <nav class="navbar navbar-edument-submenu hidden-xs">
      <div class="navbar-inner sub-menu">
          <div class="container">
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse submenu" id="navbar-collapse-submenu">
              <ul class="nav navbar-nav">
                      <li class="active"><a href="../articles.html">Blog <span class="sr-only">(current)</span></a></li>
                      <li><a href="../experts.html">Our Team</a></li>
                      <li><a href="../join-us.html">Join us</a></li>
              </ul>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container -->
      </div><!-- /.navbar-inner -->
    </nav>

    <nav class="visible-xs mobilenav">
      <a class="langlink" href="../../artiklar/index.html">
          <img src="https://media.graphcms.com/4FSF3OtzRk2bJv1kFkiD"/>
      </a>
      <ul>
            <li class="mobtop">
                <a href="../education.html">Education <span class="sr-only">(current)</span></a>
              <ul>
                    <li>
                        <a href="../education/categories.html">Categories <span class="sr-only">(current)</span></a>
                    </li>
                    <li>
                        <a href="../education/courses.html">Courses <span class="sr-only">(current)</span></a>
                    </li>
                    <li>
                        <a href="../education/events.html">Events <span class="sr-only">(current)</span></a>
                    </li>
              </ul>
            </li>
            <li class="mobtop">
                <a href="../codebuddy.html">CodeBuddy <span class="sr-only">(current)</span></a>
              <ul>
              </ul>
            </li>
            <li class="mobtop">
                <a href="../concept-and-product-development.html">Concept &amp; Product Development <span class="sr-only">(current)</span></a>
              <ul>
              </ul>
            </li>
            <li class="mobtop">
                <a href="../about.html">About us <span class="sr-only">(current)</span></a>
              <ul>
                    <li>
                        <a class="active" href="../articles.html">Blog <span class="sr-only">(current)</span></a>
                    </li>
                    <li>
                        <a href="../experts.html">Our Team <span class="sr-only">(current)</span></a>
                    </li>
                    <li>
                        <a href="../join-us.html">Join us <span class="sr-only">(current)</span></a>
                    </li>
              </ul>
            </li>
      </ul>
    </nav>
  </header>

  <div id="content">
    <main>
      

      <div class="container">
        <div class="row main-content-row">
            <div class="col-sm-9 main-content-column">

              <div class="breadcrumbs">
                      <span><a href="../about.html">About us</a></span>
                      <span><a href="../articles.html">Blog</a></span>
                      <span>Invariants hidden in callbacks</span>
              </div>

              <div class="news-details">
        <span>18 Oct 2017</span>
        <h1>Invariants hidden in callbacks</h1>

        <div class="graphcmsrich"><p>In this post I will discuss one of my favorite pet-peeves: callbacks. This post is programming language independent, though I guess it will shine through that I mainly work in C, C++ and Node.js. Callbacks are super nice for accomplishing a wide array of tasks: concern separation, asynchronous execution, future extension, etc. however there are several problems hidden in how callbacks can be implemented.</p><figure><img alt="callbacks.jpg" src="https://media.graphcms.com/bnS4FTcqS9uyDSmBDBiK"/></figure><p>The first problem is to not allow for a context to be passed through to the callback. With modern languages where we have closures this is a non-problem because the function will automatically carry the extra state with it. However in C you sometimes see a callback (which is a function pointer) used like this:</p><pre><code>// Header<br><br>// This is how we declare a function pointer with no args, returning void, called MyCallback.<br><br>typedef (void) (*MyCallback)();<br><br>void registerCallback(MyCallback *cb);<br><br><br><br>// Source<br><br>static MyCallback *g_registeredCallback = NULL;<br><br>void registerCallback(MyCallback *cb) {<br><br> &nbsp;g_registeredCallback = cb;<br><br>}<br><br><br><br>void invokeCallback() {<br><br> &nbsp;if (g_registeredCallback != NULL) {<br><br> &nbsp;&nbsp;&nbsp;g_registeredCallback();<br><br> &nbsp;}<br><br>}<br><br></code></pre><p>We register our own callbacks like this:</p><pre><code>void callbackFunction() {<br><br> &nbsp;printf("callack was invoked\n");<br><br>}<br><br> &nbsp;registerCallback(callbackFunction);<br><br> &nbsp;invokeCallback();<br><br></code></pre><p>However the API doesnâ€™t allow me to pass any extra state to the callback, so I can't attach the callback to any "object". The solution is to always pass in an extra context parameter:</p><pre><code>// Header<br><br>typedef (void) (*MyCallback)(void *context);<br><br>void registerCallback(MyCallback *cb, void *context);<br><br><br><br>// Source<br><br>static MyCallback *g_registeredCallback = NULL;<br><br>static MyCallback *g_registeredCallbackContext = NULL;<br><br>void registerCallback(MyCallback *cb, void *context) {<br><br> &nbsp;g_registeredCallback = cb;<br><br> &nbsp;g_registeredCallbackContext = context;<br><br>}<br><br><br><br>void invokeCallback() {<br><br> &nbsp;if (g_registeredCallback != NULL) {<br><br> &nbsp;&nbsp;&nbsp;g_registeredCallback(g_registeredCallbackContext);<br><br> &nbsp;}<br><br>}<br><br></code></pre><p>Now we have a state and we can connect a specific callback invocation to an object. This is automatically solved in JavaScript since a function reference contains it's closure (for non-javascript programmers here is an example of what this means):</p><pre><code>function generateCallback() {<br><br> &nbsp;var closureVariable = 32;<br><br> &nbsp;return function() {<br><br> &nbsp;&nbsp;&nbsp;console.log('the closure variable is', closureVariable);<br><br> &nbsp;&nbsp;&nbsp;closureVariable++;<br><br> &nbsp;}<br><br>}<br><br><br><br>let callback1 = generateCallback();<br><br>callback1(); // prints 32<br><br>callback1(); // prints 33<br><br><br><br>let callback2 = generateCallback();<br><br>callback2(); // prints 32<br><br>callback1(); // prints 34<br><br></code></pre><p>The next problem is that when we invoke a callback we need to consider that the callback can do <em>anything</em>. Take following example where we store callbacks in an array and then later we will process them and clear the callback queue (this time implemented in JavaScript so the context problem from above is automatically solved).</p><pre><code>let callbacks = [];<br><br>function registerCallback(cb) {<br><br> &nbsp;callbacks.push(cb);<br><br>}<br><br><br><br>function processCallbacks() {<br><br> &nbsp;callbacks.forEach(cb =&gt; cb());<br><br> &nbsp;callbacks = [];<br><br>}<br><br></code></pre><p>The implementation looks innocent, however consider following usage:</p><pre><code>registerCallback(() =&gt; {<br><br> &nbsp;registerCallback(() =&gt; {<br><br> &nbsp;&nbsp;&nbsp;console.log('When is this called?')<br><br> &nbsp;});<br><br>});<br><br></code></pre><p>and boom an infinite loop. This problem has many variations, for instance if we allow a callback to be unregistered, can we unregister ourselves from within the callback? The common trait for these problems is that we have some <em>invariant</em> that gets violated, i.e. when we wrote the functions we expected the callbacks array to not be modified while we are processing callbacks.</p><p>To ensure we don't violate the invariant we can rewrite like this:</p><pre><code>function processCallbacks() {<br><br> &nbsp;let internalCallbacks = callbacks;<br><br> &nbsp;callbacks = [];<br><br><br><br> &nbsp;internalCallbacks.forEach(cb =&gt; cb());<br><br>}<br><br></code></pre><p>Now we first make a copy of the globally accessible object so registering a new callback while we process callbacks will not be executed.</p><p>My final point around callbacks is to always have same state when invoking the callbacks. With state I mean callstack, mutexes held, etc. Consider following example:</p><pre><code>function doProcess(callback) {<br><br> &nbsp;if (Math.rand() &lt; 0.5) {<br><br> &nbsp;&nbsp;&nbsp;callback(Math.rand());<br><br> &nbsp;&nbsp;&nbsp;return;<br><br> &nbsp;}<br><br><br><br> &nbsp;globalVariable++;<br><br> &nbsp;callback(Math.rand());<br><br>}<br><br></code></pre><p>when the callback is invoked we will not know if the global variable has been updated or not. Common versions of this problem is to have different execution flows where the callback is invoked with different mutexes held along the different paths, or calling a callback both synchronously and asynchronously. A nice solution is to refactor the code so the callback is only ever invoked from one place. Also notice that if you ever refactor your code so the callback is invoked in a different state (for instance holding different mutexes or executing on a different thread) can lead to hard diagnosed and mysterious bugs.</p><p>To summarize, the bugs come down to <em>breaking invariants</em>, and when the invariants are implicit it can be hard to spot the problems. The invariants can be broken either by the callback doing things the callback invoker didn't expect, or reversely the signaller invoking the callback at times the callback didn't expect to be invoked.</p><p>In Node.js we can often get around the problems by executing the callbacks from a <code>process.nextTick</code> callback:</p><pre><code>function processCallbacks() {<br><br> &nbsp;callbacks.forEach(cb =&gt; process.nextTick(() =&gt; cb()));<br><br> &nbsp;callbacks = [];<br><br>}<br><br></code></pre><p>and then we need to accept that our callbacks always will fire asynchronously. In C and C++ there is no general solution for executing deferred callbacks, so in a future post we will look at what our options are there.</p></div>

            <div class="authorlist">
                    <div class="teacher-info">
                        <a href="../experts/erik-man.html" title="Read more about Erik Man">
                            <div><img src="https://media.graphcms.com/awqGFSuoQ3uyMTdIsDf5"/></div>
                            Erik Man
                        </a>
                    </div>
            </div>
        <div>
            <a href="https://www.linkedin.com/shareArticle?mini=true&source=Edument+AB&url=undefined&title=Invariants%20hidden%20in%20callbacks&summary=%3Cp%3ECallbacks%20might%20look%20simple%20and%20innocent%2C%20but%20they%20can%20be%20dangerous!%3C%2Fp%3E" target="_blank"><img class="social_media_icons" src="https://media.graphcms.com/1upE2T1wQ8u4EqDFBvRo" alt="Linked in logo"></a>
            <a href="http://www.twitter.com/share?url=undefined" target="_blank"><img class="social_media_icons" src="https://media.graphcms.com/23CqzyNDTCq0xPAWpObq" alt="Twitter logo"></a>
            <a href="http://www.facebook.com/sharer/sharer.php?u=undefined" target="_blank"><img class="social_media_icons" src="https://media.graphcms.com/YUirH01BTaacmUSVSuZf" alt="Facebook logo"></a>
        </div>
    </div>

            </div>
            <div class="col-sm-3 side-content-column">
              <div class="right-hand-column">


    <h2><span data-contentid="right-hand-column-news" data-contenttype="TEXT">
                  News &amp; feeds
              </span></h2>

        <h3>CSS selectors are evil and JS is the solution</h3>
        <p>A pragmatic demonstration of the drawbacks with CSS selectors, and how inline styles through JS solves these problems</p>
        <a href="css-selectors-are-evil-and-js-is-the-cure.html"><span data-contentid="right-hand-read-more-croc" data-contenttype="TEXT">
                  Read more >
              </span></a>
        <h3>Top 5 Podcasts during Christmas</h3>
        <p>We at Edument would like to thank you for this year and wish you &nbsp;a Merry Christmas and a Happy New Year with our top 5 Podcasts list!</p>
        <a href="top-5-Podcasts-during-christmas.html"><span data-contentid="right-hand-read-more-croc" data-contenttype="TEXT">
                  Read more >
              </span></a>
        <h3>Invariants hidden in callbacks</h3>
        <p>Callbacks might look simple and innocent, but they can be dangerous!</p>
        <a href="invariants-in-callbacks.html"><span data-contentid="right-hand-read-more-croc" data-contenttype="TEXT">
                  Read more >
              </span></a>
        <h3>Expanding boundaries</h3>
        <p>What it means to boldly go where you have never been before</p>
        <a href="expanding-boundaries.html"><span data-contentid="right-hand-read-more-croc" data-contenttype="TEXT">
                  Read more >
              </span></a>
        <h3>How to create a course </h3>
        <p>Iâ€™ve always admired my colleagues work theyâ€™ve put into creating great and rewarding courses, I imagined it was a challenging and time-consuming task. &nbsp;I can see the meaning of that now, because all of a sudden I am developing a course.</p>
        <a href="course-developing.html"><span data-contentid="right-hand-read-more-croc" data-contenttype="TEXT">
                  Read more >
              </span></a>
</div>

            </div>
        </div>

      </div>
    </main>
    <footer>
      <div class="container footer-content">
      <div class="row newsletter-subscription">
        <div class="col-md-6">
              <h2><span data-contentid="master-footer-subscribe-headline" data-contenttype="TEXT">
                  Edument news
              </span></h2>
              <p><span data-contentid="master-footer-subscribe-description" data-contenttype="TEXT">
                  Subscribe and we'll keep you in the loop with our latest courses, news and thoughts.
              </span></p>
          </div>
          <div class="col-md-6 subscription-right">
              <div class="subscription-feedback">
                  <span data-contentid="master-footer-subscribe-feedback" data-contenttype="TEXT">
                  Subscribing...
              </span>
              </div>
              <form class="subscription-form">
                  <input type="email" value="" name="EMAIL" class="subscriber-email" placeholder="email address" required>
                  <input type="submit" value="Subscribe" name="subscribe" class="actionlink">
               </form>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <h2><span data-contentid="master-footer-contact-us" data-contenttype="TEXT">
                  Contact us
              </span></h2>
            Tel: <span data-contentid="master-phone" data-contenttype="TEXT">
                  +46 40 - 61 70 720
              </span><br>
            <a href="mailto:info@edument.se" data-id-href="content.text.master-mailto-info">info@edument.se</a><br>
          </div>
          <div class="col-md-5">
            <h2><span data-contentid="master-footer-visit-us" data-contenttype="TEXT">
                  Visit us
              </span></h2>
            <div class="col-md-5 addresslist">
              <ul data-contentid="master-address-helsingborg data-contenttype="LIST">
          <li>Helsingborg office</li><li>Sundstorget 5</li><li>252 21 Helsingborg</li><li>Sweden</li>
        </ul>
              <a class="mapurl" href="https://www.google.com/maps/place/Edument/@56.0484963,12.687333,17z/" target="_blank"><i><span data-contentid="master-footer-find-on-map" data-contenttype="TEXT">
                  Find on map
              </span></i></a>
            </div>
            <div class="col-md-7 addresslist">
              <ul data-contentid="master-address-malmo data-contenttype="LIST">
          <li>MalmÃ¶ office</li><li>Stora varvsgatan 6A</li><li>211 19 MalmÃ¶</li><li>Sweden</li>
        </ul>
              <a class="mapurl" href="https://www.google.com/maps/place/Edument+AB/@55.6122624,12.9895262,17z/" target="_blank"><i><span data-contentid="master-footer-find-on-map" data-contenttype="TEXT">
                  Find on map
              </span></i></a>
            </div>
          </div>
          <div class="col-md-3">
            <h2><span data-contentid="master-footer-follow-us" data-contenttype="TEXT">
                  Follow us
              </span></h2>
            <div class="follow-us">
              <a target="_blank" href="https://www.linkedin.com/company/edument-ab"><img class="social" src="https://media.graphcms.com/1upE2T1wQ8u4EqDFBvRo" alt="Linkedin logo"></a>
              <a target="_blank" href="https://www.instagram.com/edument/"><img class="social" src="https://media.graphcms.com/3b8PshtAQGCKfiHNawk4" alt="Instagram logo"></a>
              <a target="_blank" href="https://www.facebook.com/EdumentAB/"><img class="social" src="https://media.graphcms.com/YUirH01BTaacmUSVSuZf" alt="Facebook logo"></a>
              <a target="_blank" href="https://twitter.com/edument"><img class="social" src="https://media.graphcms.com/23CqzyNDTCq0xPAWpObq" alt="Twitter logo"></a>
            </div>
          </div>
        </div>
      </div>
      <div class="privacy">
        <div class="container">
          <div class="row">
            <div class="col-xs-6">
              <span data-contentid="master-footer-copyright" data-contenttype="TEXT">
                  Copyright Â© Edument AB. All rights reserved.
              </span>
            </div>
            <div class="col-xs-2 privacy-disclaimers">
              <a href="../partners-and-resellers.html"><span data-contentid="master-footer-partners-link-text" data-contenttype="TEXT">
                  Partners & resellers
              </span></a>
            </div>
            <div class="col-xs-2 privacy-disclaimers">
              <a href="../terms-and-conditions.html"><span data-contentid="master-footer-termcond-link-text" data-contenttype="TEXT">
                  Terms & conditions
              </span></a>
            </div>
            <div class="col-xs-2 privacy-disclaimers">
              <a href="../privacy.html"><span data-contentid="master-footer-privacy-link-text" data-contenttype="TEXT">
                  Privacy & disclaimers
              </span></a>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <script type="text/javascript" src="../../scripts/newsletter-subscription.js"></script>
  <script type="text/javascript" src="../../scripts/shrink-menu.js"></script>
  <script type="text/javascript" src="../../scripts/expander.js"></script>

  <!-- Apsis Tracking code for www.edument.se -->
  <script type='text/javascript'>
    var psSite = 'e285ed6809';
    (function() {
    var AL = document.createElement('script'); AL.type = 'text/javascript'; AL.async = true;
    AL.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'tr.apsislead.com/al_v2.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(AL, s)
    })();
  </script>
  <noscript><img src='http://tr.apsislead.com/?id=e285ed6809' style='border:0;display:none;'></noscript>
  <!-- End Tracking code -->

</body>
</html>
